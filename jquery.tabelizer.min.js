/*
 * 
 * Tabelizer 1.0 - multi level grouping indicators for tables
 * Version 1.0.0
 * @requires jQuery v1.6+ and jQuery.ui core
 * 
 * Copyright (c) 2014 Rafael Huisman
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 */

/**
 * 
 * @description Create a table with multi level grouping indicators.
 * 
 * @example $('#table1').tabelize();
 * @desc Create a simple tabelized interface.
 */
!function(e){var a={};a.rowClicker=function(l){var r=e(l.currentTarget),t=r.attr("id");r.hasClass("contracted")?(r.removeClass("contracted").addClass("expanded"),a.toggleChildren(t,!0)):(r.removeClass("expanded").addClass("contracted"),a.toggleChildren(t,!1)),a.updateLines()},a.updateLines=function(){var l="",r="";if($prevRow=null,e("#"+a.tableId+" tr:not(.hidden)").each(function(){if($row=e(this),!$row.hasClass("header")){l=$row.data("level");for(var t="",d=a.maxLevel;d>0;d--)$row.removeClass("l"+d+"-first").removeClass("l"+d+"-last");if(l!=r&&(t+=" l"+l+"-first",""!=r&&r>l))for(var d=r;d>=l;d--)$prevRow.addClass(" l"+parseInt(d)+"-last");$row.addClass(t),r=l,$prevRow=$row}}),null!=$prevRow&&""!=r&&r>1)for(var t=r-1;t>0;t--)$prevRow.addClass(" l"+parseInt(t)+"-last")},a.toggleChildren=function(l,r){var t=!1,d=!1,s=null,n=0;e("#"+a.tableId+" tr").each(function(){var a=e(this),i=a.attr("id"),o=a.data("level"),v=!1;t||i!=l?t&&!d&&null!=s&&o==n?d=!0:r&&t&&!d&&null!=s&&o!=n+1?v=!0:!r&&t&&!d&&null!=s&&n>o&&(d=!0,v=!0):(t=!0,n=o),v||!t||d||i==l||(r?(a.removeClass("hidden"),a.find("td").wrapInner('<div style="display: none;" />').parent().find("td > div").slideDown(200,function(){var a=e(this);a.replaceWith(a.contents())})):(a.find("td").wrapInner('<div style="" />').parent().find("td > div").slideUp(200,function(){var l=e(this);l.replaceWith(l.contents()),a.addClass("hidden")}),a.removeClass("expanded"),a.addClass("contracted"))),s=o})},a.maxLevel=0,a.init=function(){var l="",r="";if($prevRow=null,e("#"+a.tableId+" tr").each(function(){if($row=e(this),!$row.hasClass("header")){l=$row.data("level");var t="l"+l+" contracted "+(l>1?" hidden":"");if(l!=r&&(t+=" l"+l+"-first",""!=r&&r>l))for(var d=r;d>=l;d--)$prevRow.addClass(" l"+parseInt(d)+"-last");l>a.maxLevel&&(a.maxLevel=parseInt(l)),$row.addClass(t),$firstCol=e($row.children("td")[0]);for(var s='<div class="label">'+$firstCol.html()+"</div>",n='<div class="control"> ',d=0;l-1>=d;d++)n+=' <div class="line level'+(d+1)+'"><div class="vert"></div><div class="horz"></div></div> ';n+="</div>",$firstCol.html(n+' <div class="epxander"></div> '+s),$row.on("click",a.rowClicker),r=l,$prevRow=$row}}),null!=$prevRow&&""!=r&&r>1)for(var t=r-1;t>0;t--)$prevRow.addClass(" l"+parseInt(t)+"-last")},e.fn.tabelize=function(){a.caller=this,a.tableId=this.attr("id"),a.init()}}(jQuery);